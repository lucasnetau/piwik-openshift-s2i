#!/bin/bash

set -e

shopt -s dotglob
echo "---> Installing Piwik LATEST source..."

install_version=$(curl https://builds.piwik.org/LATEST)
curl -O https://builds.piwik.org/piwik-${install_version}.tar.gz

tar --strip-components=1 -xzf piwik-${install_version}.tar.gz

rm piwik-${install_version}.tar.gz

echo php_flag opcache.validate_timestamps 0 >> .htaccess
cat << 'EOF' >> .htaccess
# turn on gzip compression and caching for piwik.js
<IfModule mod_expires.c>
  # Enable expirations.
  ExpiresActive On

  <Files "piwik.js">
     SetOutputFilter DEFLATE
     ExpiresDefault "access plus 7 days"
  </Files>
</IfModule>
EOF

# Fix source directory permissions
fix-permissions ./
